<!DOCTYPE html>
<html>
    <head>
        <title>Oculus API App Versions</title>
        <meta property="og:site_name" content="ComputerElite">
        <meta property="og:title" content="Oculus API App Versions" />
        <meta property="og:description" content="A page to get downloads for various Oculus apps" />
        <meta property="og:url" content="https://computerelite.github.io/tools/Oculus/AppVersions.html" />
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
        <link href="../../css/standard.css" type="text/css" rel="stylesheet">
        <link rel="icon" href="../../assets/CE_64px.png" type="image/x-icon">
        <style>
            td {
                padding: 10px;
            }
    
            .item {
                flex: 1;
                width: 25%;
                word-wrap: break-word;
                padding: 3px;
            }
        </style>
    </head>
    <body>
        <div style="padding-top: 10px; width: 100%; display: flex;">
            <div style="flex: 1; background-color: #2F3136; padding: 10px;">
                <div style="font-size: 24px; text-align: center;">Oculus API App Versions</div>
                <div style="font-size: 15px; text-align: center; color: #888;">
                    Get download links for all Oculus apps
                </div>

                <table style="padding: 10px; width: 700px; margin: auto; margin-top: 40px;">
                    <tr>
                        <td>
                            <input type="checkbox" id="beta">
                            <div style="display: inline;">Show latest beta</div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Headset
                        </td>
                            <td>
                                <select id="headset">
                                <option value="MONTEREY">Quest</option>
                                <option value="RIFT">Rift (downloads not working)</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Search term for app
                        </td>
                        <td>
                            <input type="text" value="Beat Saber" id="searchTerm" spellcheck="false" onkeydown='if(event.keyCode == 13) Search()'>
                        </td>
                        <td>
                            <input type="button" value="Search" onclick="Search()">
                        </td>
                    </tr>
                </table>
                <div id="notesContainer" style="margin-bottom: 50px;">

                </div>
                <div id="resultContainer">
                    <div style="display: flex; flex-wrap: wrap;">
                        <div style="flex: 1; background-color: #222222; font-size: 18px; padding: 5px; margin: 5px;">
                            <table style="width: fit-content; margin: auto;">
                                <tr><td><img src="../../assets/CE_512px.png" width="100px" height="100px"></td><td>Please search</td></tr>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="contextMenu" class="contextMenu">
                    <div class="contextMenuItem" onclick="navigator.clipboard.writeText(forClipboard)">Copy id</div>
                    <div class="contextMenuItem" onclick="SetClipboardLink()">Copy link</div>
                </div>

                <div class="guideHeader">How do I use this?</div>
                <div class="guideSteps" id="instructions">
                    Log in on  <a href="https://www.oculus.com/">oculus.com</a>, search for an app, click on it, click on the version your want to download and you got yourself an apk you can install.
                </div>
                <div class="guideHeader">Is this legal?</div>
                <div class="guideSteps">
                    I cannot give an 100% correct answer on that. But it uses Oculus public API and official download servers (for which you need to own the app and be logged in on <a href="https://www.oculus.com/">oculus.com</a> to download the app) to get all the information.
                    <br/>
                    So if you ask me I'd say yes, it is legal.
                </div>
                <br/>
                <div style="text-align: center; font-size: 11px; color: #888;">
                    API requests found by Lillie. Page by ComputerElite
                </div>
            </div>
        </div>
        <script src="../../js/standard.js"></script>
        <script>
            var menu = document.getElementById("contextMenu")
            var showingVersions = false
            var showedid = ""
            const versionSkeleton = `<div style="font-size: 22px; text-align: center; font-weight: bold;" id="versionHeader">Versions</div>
                    <div style="font-size: 18px; color: #EEEEEE; text-align: center; display: flex; justify-content: center; width: 100%;">
                        <div class="item">Version</div>
                        <div class="item">Changelog</div>
                        <div class="item">id</div>
                    </div>
                    <div id="versions" style="display: flex; color: #EEEEEE; width: 100%; justify-content: space-evenly; flex-direction: column;">

                    </div>`
            const storeSkeleton = `<div style="display: flex; flex-wrap: wrap;" id="apps">
                    </div>`

                    const loader = `<div class="loader" style="width: 60px; height: 60px; margin: auto;"></div>`

            var url = new URL(window.location.href);
            var id = url.searchParams.get("id");

            if(id != undefined && id != "") {
                SearchVersions(id)
            }

            var menuOpen = false;

            document.onclick = (e) => {
                menu.style.display = "none"
            }

            var forClipboard = ""
            var isVersion = false;

            function SetClipboardLink() {
                navigator.clipboard.writeText(isVersion ? GetDownloadLink(forClipboard) : window.location.href.split('?')[0] + "?id=" + forClipboard)
            }

            function SetupContextMenu(e, id, version) {
                if(menuOpen && forClipboard == id) {
                    menuOpen = false
                    menu.style.display = "none"
                } else {
                    isVersion = version
                    forClipboard = id
                    menuOpen = true
                    menu.style.display = "block"
                    menu.style.top = mouseY(event) + 'px';  
                    menu.style.left = mouseX(event) + 'px';
                    return false
                }
                
            }

            function Search() {
                document.getElementById("notesContainer").innerHTML = "";
                showingVersions = false;
                document.getElementById("resultContainer").innerHTML = storeSkeleton
                document.getElementById("apps").innerHTML = loader
                PostRequest("https://graph.oculus.com/graphql", `access_token=OC|1317831034909742|&variables={"query":"${document.getElementById("searchTerm").value}","hmdType":"${document.getElementById("headset").value}","firstSearchResultItems":100}&doc_id=4446310405385365`).then((res) => {
                    document.getElementById("apps").innerHTML = ""
                    res.data.viewer.contextual_search.all_category_results.forEach(cat => {
                        if(cat.name == "APPS") {
                            document.getElementById("apps").innerHTML = ""
                            cat.search_results.nodes.forEach(element => {
                                document.getElementById("apps").innerHTML += GetResultFormatted({
                                    imgsrc: element.target_object.cover_square_image.uri,
                                    name: element.target_object.display_name,
                                    id: element.target_object.id
                                })
                            })
                        }
                    })
                    if(document.getElementById("apps").innerHTML == "") {
                        document.getElementById("apps").innerHTML = "<div style='font-size: 24px; text-align: center; flex: 1;'>Nothing found</div>"
                    }
                }).catch(err => {
                    document.getElementById("apps").innerHTML = "<div style='font-size: 24px; text-align: center; flex: 1;'>An error occured. Please try again later.</div>"
                })
            }

            function GetDownloadLink(id) {
                return "https://securecdn.oculus.com/binaries/download/?id=" + id
            }

            document.getElementById("beta").onchange = (e) => {
                if(showingVersions) SearchVersions(showedid)
            }

            function SearchVersions(id) {
                document.getElementById("notesContainer").innerHTML = "";
                showedid = id
                showingVersions = true;
                document.getElementById("resultContainer").innerHTML = versionSkeleton
                document.getElementById("versions").innerHTML = loader
                var versions = []
                PostRequest("https://graph.oculus.com/graphql", `access_token=OC|1317831034909742|&variables={"id":"${id}"}&doc_id=1586217024733717`).then((res) => {
                    document.getElementById("versionHeader").innerHTML = `Versions for ${res.data.node.displayName}`
                    res.data.node.supportedBinaries.edges.forEach(element => {
                        versions.push({
                            version: element.node.version,
                            changelog: element.node.changeLog,
                            id: element.node.id,
                            name: res.data.node.displayName
                        })
                    })
                    if(document.getElementById("beta").checked) {
                        PostRequest("https://graph.oculus.com/graphql", `access_token=OC|1317831034909742|&variables={"itemId":"${id}","first":5,"last":null,"after":null,"before":null,"forward":true,"ordering":null,"ratingScores":null,"hmdType":"MONTEREY" }&doc_id=5373392672732392`).then((res) => {
                            res.data.node.release_channels.nodes.forEach(element => {
                                var contained = false;
                                versions.forEach(e => {
                                    if(e.id == element.latest_supported_binary.id) {
                                        contained = true;
                                    }
                                })
                                if(!contained) {
                                    versions.unshift({
                                        version: "[" + element.channel_name + "] " + element.latest_supported_binary.version,
                                        changelog: "N/A",
                                        id: element.latest_supported_binary.id
                                    })
                                }
                            })
                            document.getElementById("versions").innerHTML = ""
                            versions.forEach(e => {
                                document.getElementById("versions").innerHTML += GetFormatted(e)
                            })
                            if(document.getElementById("versions").innerHTML == "") {
                                document.getElementById("versions").innerHTML = "<div style='font-size: 24px; text-align: center; flex: 1;'>Nothing found</div>"
                            }
                        })
                    } else {
                        document.getElementById("versions").innerHTML = ""
                        versions.forEach(e => {
                            document.getElementById("versions").innerHTML += GetFormatted(e)
                        })
                        if(document.getElementById("versions").innerHTML == "") {
                            document.getElementById("versions").innerHTML = "<div style='font-size: 24px; text-align: center; flex: 1;'>Nothing found</div>"
                        }
                    }
                    
                    
                }).catch(err => {
                    document.getElementById("versions").innerHTML = "<div style='font-size: 24px; text-align: center; flex: 1;'>An error occured. Please try again later.</div>"
                })
                MakeJSONGetRequestAsync("AppNotes/index.json").then(res => {
                    if(res.includes(id)) {
                        MakeTextGetRequestAsync(`AppNotes/${id}.html`).then(res => {
                            document.getElementById("notesContainer").innerHTML = res
                        })
                    }
                })
            }

            function DownloadAPK(id) {
                var link = GetDownloadLink(id)
                console.log("requesting " + link)
                var xhr = new XMLHttpRequest();
                xhr.open("HEAD", link, true); // Notice "HEAD" instead of "GET",
                                            //  to get only the header
                xhr.onreadystatechange = function() {
                    if (this.readyState == this.DONE) {
                        //Success
                        window.open(link, "_blank")
                    }
                };
                xhr.onerror = (err) => {
                    if(confirm("Unable to start download. Are you logged in on Oculus.com and own the game? If you think this detection is wrong press cancle")) {
                        window.open("https://oculus.com", "_blank")
                    } else {
                        window.open(link, "_blank")
                    }
                }
                xhr.send();s
            }

            function GetFormatted(element) {
                return `<a style="font-size: 16px; color: #EEEEEE; text-align: center; display: flex; width: 100%; cursor: pointer;" onclick="DownloadAPK(${element.id})" oncontextmenu="return SetupContextMenu(event, '${element.id}', true)" download>
                            <div class="item">${element.version}</div>
                            <div class="item">${element.changelog.replace("\n", "<br/>")}</div>
                            <div class="item">${element.id}</div>
                        </a>
                        <div style='width: 90%; margin-left: auto; margin-right: auto;'><hr></div>`
            }

            function GetResultFormatted(element) {
                return `<a style="flex: 1; background-color: #222222; font-size: 18px; padding: 5px; margin: 5px; cursor: pointer;" onclick="SearchVersions('${element.id}')" oncontextmenu="return SetupContextMenu(event, '${element.id}', false);">
                            <table style="width: fit-content; margin: auto;" class="defTextColor">
                                <tr><td><img src="${element.imgsrc}" width="100px" height="100px"></td><td>${element.name}</td></tr>
                            </table>
                        </a>`
            }

            function PostRequest(url, body) {
                return new Promise((resolve, reject) => {
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", url, true);
                    xhr.onerror = (err) => {
                        reject(err)
                    }
                    xhr.onreadystatechange = () => {
                        if (xhr.readyState == XMLHttpRequest.DONE) {
                            resolve(JSON.parse(xhr.responseText))
                        }
                    }
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    xhr.send(body);
                })
            }
        </script>
    </body>
</html>
