<html>
    <head>
        <title>Level Stats Viewer Quest Overlay</title>
        <meta property="og:site_name" content="ComputerElite">
        <meta property="og:title" content="Level Stats Viewer Quest Overlay" />
        <meta property="og:description" content="An overlay for Level Stats Viewer for Beat Saber on Quest" />
        <meta property="og:url" content="https://computerelite.github.io/" />
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
        <link href="../../css/standart.css" type="text/css" rel="stylesheet">
        <script src="../../js/standart.js"></script>
        <link rel="icon" href="../../assets/CE_64px.png" type="image/x-icon">
        <style>
            body {
                background-color: #00000000;
            }
        </style>
    </head>
    <body>
        <div style="position: absolute; left: 10px; top: 10px; background-color: #222222; border-radius: 5px; padding: 10px;">
            <div style="font-size: 24px;" id="songName">Song name</div>
            <div style="display: flex;">
                <div style="flex: 1;">
                    <img style="width: 100px; height: 100px;" src="../../assets/CE_64px.png" id="cover">
                </div>
                <div style="flex: 1; padding-left: 10px;">
                    <div style="font-size: 15px;">Artist: <div style="font-size: 18px;" id="songAuthor">Artist</div></div>
                    <div style="font-size: 15px; margin-top: 10px; margin-bottom: 10px;">Mapper: <div style="font-size: 18px;" id="mapper">Mapper</div></div>
                    <div style="font-size: 15px;" id="diff">diff</div>
                    <div style="font-size: 11px;" id="key">key: </div>
                </div>
            </div>
            <div style="font-size: 15px;" id="combo">Combo: </div>
            <div style="font-size: 15px;" id="score">Score: </div>
            <div style="font-size: 15px;" id="rank">Rank: </div>
        </div>
        <div style="width: 30%; height: 2%; position: absolute; background-color: #222222; border-radius: 3px; margin: auto; bottom: 10px; left: 0px; right: 0px; padding: 1px;">
            <div id="energybar" style="height: 100%; width: 100%; background: #00FFFF; border-radius: 2px;">
            </div>
        </div>
        <script>
            var url_string = window.location.href
            var url = new URL(url_string);
            var ip = url.searchParams.get("ip");

            var bar = document.getElementById("energybar")
            var songName = document.getElementById("songName")
            var songAuthor = document.getElementById("songAuthor")
            var mapper = document.getElementById("mapper")
            var diff = document.getElementById("diff")
            var combo = document.getElementById("combo")
            var score = document.getElementById("score")
            var cover = document.getElementById("cover")
            var key = document.getElementById("key")
            var rank = document.getElementById("rank")

            console.log("Ip: " + ip)

            setInterval(function() {
                //var s = new WebSocket("ws://" + ip + ":3501")
                var s =  fetch("http://" + ip + ":3501").then((response) => {
                    var stats = response.json().then((stats) => {
                        console.log(stats)
                        SetPercentage(stats["energy"])
                        songName.innerHTML = format(stats["levelName"])
                        songAuthor.innerHTML = "<i>" + format(stats["songAuthor"]) + "</i>"
                        mapper.innerHTML = format(stats["mapper"])
                        diff.innerHTML = intToDiff(stats["difficulty"])
                        combo.innerHTML = "Combo: " + format(stats["combo"], 1)
                        score.innerHTML = "Score: " + format(stats["score"], 1)
                        rank.innerHTML = "Rank: " + format(stats["rank"], 2)
                        SetImage(stats["id"])
                    })
                })
            }, 1000)

            var lastID = "";

            function SetImage(id) {
                if(!id.startsWith("custom_level_")) return;
                if(id == lastID) return;
                lastID = id
                fetch("https://beatsaver.com/api/maps/by-hash/" + id.replace("custom_level_", "")).then((result) => {
                    result.json().then((json) => {
                        cover.src = "https://beatsaver.com" + json["coverURL"]
                        key.innerHTML = "Key: " + json["key"]
                    })
                })
            }

            function format(text, returnType = 0) {
                return text == "" ? (returnType >= 1 ? (returnType >= 2 ? "SS" : "0") : "N/A") : text
            }

            function intToDiff(diff) {
                switch (diff)
                {
                    case 0:
                        return "Easy";
                    case 1:
                        return "Normal";
                    case 2:
                        return "Hard";
                    case 3:
                        return "Expert";
                    case 4:
                        return "Expert+";
                }
                return "Unknown";
            }

            function SetPercentage(percentage) {
                bar.style.width = (percentage * 100) + "%"
            }
        </script>
    </body>
</html>