<head>
    <title>APK Downgrader - Web</title>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
    <script src="libpatch.js?2"></script>
    <script src="lzma.js"></script>
    <link href="../../css/standart.css" type="text/css" rel="stylesheet">
    <script src="../../js/standart.js"></script>
    <style>
    td {
        padding: 10px;
    }

    .os {
        font-size: 16px;
        color: #EEE;
    }

    .item {
        flex: 1;
        width: 25%;
        word-wrap: break-word;
        padding: 3px;
    }

    .itemR {
        flex: 1;
        width: 25%;
        word-wrap: break-word;
        padding: 3px;
        color: #FF2222;
    }

    .devicesRowItem {
        flex: 1;
        width: 16%;
        text-align: center;
    }

    .devicesRowItemN {
        flex: 1;
        width: 16%;
        color: #FF2222;
        text-align: center;
    }

    .devicesRowItemY {
        flex: 1;
        width: 16%;
        color: #00BB00;
        text-align: center;
    }

    .devicesRow {
        flex: 1;
        display: flex;
        flex-direction: row;
        margin-top: 3px;
        margin-bottom: 3px;
    }

    .guideHeader {
        font-size: 16px;
        margin-top: 10px;
    }

    .guideSteps {
        font-size: 14px;
        margin-top: 5px;
        padding-left: 10px;
    }

    .topicContainer {
        padding-left: 10px;
    }
    
    </style>
    </head>
    <body style="font-size: 14px;">
        <div style="display: flex; flex-direction: column; width: 100%; height: 100%;">
            <div style="flex: 1; flex-grow: 0; text-align: center;">
                <div style="background-color: rgb(47,49,54); display: inline-block; margin-top: 20px; margin-bottom: 10px; width: 80%;">
                    <div style=" padding: 10px;">
                        <div style="font-size: 24px;">APK Downgrader - Web</div>
                        <div class="headerDescription">Based on <a href="https://hack64.net/tools/patcher.php" target="_blank">Hack64's Web Patcher</a></div>
                    </div>
                    <table style="padding: 10px; width: 100%;">
                        <tr><td>APK</td><td><input type="file" style="width: 100%;" id="input-rom" accept=".apk"></td></tr>
                        <tr><td>Downgrade file</td><td><input type="file" style="width: 100%;" id="input-patch" accept=".bin, .xdelta, .xdelta3, .decr"></td></tr>
                        <tr><td>Save as</td><td><input type="text" style="width: 100%;" id="input-saveas" spellcheck="false"></td></tr>
                    </table>
                    <table style="width: 100%;">
                        <tr>
                            <td>
                                <label style="padding: 5px; font-size: 12px; vertical-align: center;" title="Skip checksum verification (not recommended)">
                                    <input type="checkbox" style="vertical-align: middle;" id="input-skip-checksums">
                                    <span style="margin-left: 5px;">Skip checksums</span>
                                </label>
                            </td>
                            <td style="text-align: right;">
                                <input type="button" value="Downgrade" id="input-apply" disabled="true">
                            </td>
                        </tr>
                    </table>
                    <div style="background: #666; text-align: left;">
                        <div id="progress-bar" style="display: inline-block; height: 2px; width: 0px; background: #00FFFF;"></div>
                    </div>
                </div>
            </div>
            <div style="flex: 1; flex-grow: 0; text-align: center;">
                <div style="background-color: rgb(47,49,54); display: inline-block; margin-top: 10px; width: 80%; margin-bottom: 10px;">
                    <div style="padding: 10px;">
                        <div style="font-size: 24px;">Download patches</div>
                        <div class="headerDescription" style="width: 50%; margin: auto;">Pulled from <a href="https://github.com/ComputerElite/APKDowngrader" target="_blank">APK Downgrader</a><i> (click text to download). Red patches may not work on 32 bit brosers as MS Edge, Google Chrome and Opera. It gets Red with 3GB est. RAM usage and more</i></div>
                        <br/>
                        <div id="patches" style="display: flex; color: #EEEEEE; width: 100%; justify-content: space-evenly; flex-direction: column;">
                            <a style="font-size: 22px; color: #EEEEEE; text-align: center; display: flex; justify-content: center; width: 100%;">
                                <div class="item">App</div>
                                <div class="item">APK Version</div>
                                <div class="item">Est. RAM Usage</div>
                                <div class="item">Target Version</div>
                            </a>
                            
                        </div>
                        <br/>
                        <div class="headerDescription"><a href="https://github.com/ComputerElite/wiki/wiki/APK-Downgrader#how-do-i-generate-downgrade-files" target="_blank">Create patches with APK Downgrader</a></div>
                    </div>
                </div>
            </div>
            <div style="flex: 1; flex-grow: 0; text-align: center;">
                <div style="background-color: rgb(47,49,54); display: inline-block; margin-top: 10px; width: 80%; margin-bottom: 20px;">
                    <div style="padding: 10px;">
                        <div style="font-size: 24px;">Notes</div>
                        <div style="font-size: 20px; text-align: left;">
                            Tested Devices + Browsers
                            <div class="headerDescription">Tested with Beat Saber 1.15.0 to 1.13.2. Smaller Apps may work on more devices. This data is only by one person each so it might be incorrect. N/A means the browser hasn't been tested/doesn't exist.</i></div>
                            <div class="topicContainer">
                                <div style="font-size: 14px;">Since the Web Version uses lots of RAM atm <i>(read for your patch above)</i> I figured this List would help you a bit. <i>General guideline: Min RAM on light weight OS: 4GB, recommended: 8 GB</i></div> 
                            </br>
                                <div style="font-size: 14px; color: #DDD;">
                                    <div style="display: flex; flex-direction: column;">
                                        <div class="devicesRow" style="font-size: 16px;">
                                            <div class="devicesRowItem">Device</div>
                                            <div class="devicesRowItem">MS Edge</div>
                                            <div class="devicesRowItem">Mozilla Firefox</div>
                                            <div class="devicesRowItem">Google Chrome</div>
                                            <div class="devicesRowItem">Opera</div>
                                            <div class="devicesRowItem">Safari</div>
                                        </div>
                                        <div class="devicesRow">
                                            <div class="devicesRowItem">Oculus Quest 1</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItemN">N</div>
                                            <div class="devicesRowItemN">Oculus Broser N</div>
                                            <div class="devicesRowItem">N/A</div>
                                            <div class="devicesRowItem">N/A</div>
                                        </div>
                                        <div class="devicesRow">
                                            <div class="devicesRowItem">Oculus Quest 2</div>
                                            <div class="devicesRowItem">N/A</div>
                                            <div class="devicesRowItem">N/A</div>
                                            <div class="devicesRowItemN">Oculus Broser N</div>
                                            <div class="devicesRowItem">N/A</div>
                                            <div class="devicesRowItem">N/A</div>
                                        </div>
                                        <div class="devicesRow">
                                            <div class="devicesRowItem">Android Phone (4 GB RAM)</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItemN">N</div>
                                            <div class="devicesRowItemN">N</div>
                                            <div class="devicesRowItemN">N</div>
                                            <div class="devicesRowItem">N/A</div>
                                        </div>
                                        <div class="devicesRow">
                                            <div class="devicesRowItem">Android Phone (8+ GB RAM)</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItem">N/A</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItemN">N</div>
                                            <div class="devicesRowItem">N/A</div>
                                        </div>
                                        <div class="devicesRow">
                                            <div class="devicesRowItem">Windows (8+ GB RAM)</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItem">N/A</div>
                                        </div>
                                        <div class="devicesRow">
                                            <div class="devicesRowItem">MacOS 10.13.6+ (8+ GB RAM)</div>
                                            <div class="devicesRowItem">N/A</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItem">N/A</div>
                                            <div class="devicesRowItemY">Y</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="font-size: 11px; margin-top: 10px;"><i>Doesn't seem to work on IPhones yet cause of Apple putting restrictions on file picking. If you experience elsewise feel free to contact me.</i></div> 
                            </div>
                            <div style="font-size: 16px;">
                                <div style="font-size: 20px; margin-top: 30px;"><a style="color: #EEEEEE; cursor:default;" href="#guide">Guide</a>
                                    <div class="headerDescription">Instructions and help with this tool</i></div>
                                    <div class="topicContainer">
                                        <div class="tip">
                                            <div class="tipHeader">
                                                Tip
                                            </div>
                                            If you are on a device which has low RAM then close all Apps/programs except your browser and close your browser or this tab after downgrading.
                                                <br/>
                                            <i>(About 2GB RAM is getting used when downgrading Beat Saber)</i>
                                        </div>
                                        <div class="guideHeader">Downgrading</div>
                                        <div class="guideSteps">
                                            First Backup your APK via Sidequest and download the patch you want to use from the patches section.
                                            Then click Choose file for APK and select the APK you backed up and click Choose File for the downgrade file as well and select the patch you downloaded.
                                            Finally put in the nameyou want the downgraded file to have. e. g. Beat Saber 1.13.2 and hit Downgrade. The file should now download
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="font-size: 16px;">
                                <div style="font-size: 20px; margin-top: 30px;">Common errors
                                    <div class="headerDescription">Errors which may or may not show</i></div>
                                    <div class="topicContainer">
                                        
                                        <div class="guideHeader"><code>Array buffer allocation failed</code> or Browser crashs</div>
                                        <div class="guideSteps">
                                            This means you don't have enough RAM left. Either it'll not work on your device at all or you just have too much RAM in use.
                                        </div>

                                        <div class="guideHeader">Browser doesn't do anything after pressing Downgrade</div>
                                        <div class="guideSteps">
                                            Either your browser doesn't work with This tool or you don't have enough RAM left
                                        </div>
                                        <div class="guideHeader">I get an <code>out of memory</code> error</div>
                                        <div class="guideSteps">
                                            This means that you don't have enough RAM left. Try closing all other tabs and Apps. If the problem still occurs <i>(and you have RAM left)</i> Then the patch is too big to be used. <i>You can see estimated RAM usage above.</i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                
                        </div>
                        <br/>
                        <div>
                            The Web Version of <a href="https://github.com/ComputerElite/APKDowngrader" target="_blank">APK Downgrader</a> wouldn't have been possible without the work of <a href="https://hack64.net/tools/patcher.php" target="_blank">hack64's Web Patcher</a> which is powering most of the code behind downgrading
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <script>
    
    var sourceData = null;
    var patchData = null;
    var saveAsName = '';
    var patchFileName = '';
    
    var domInputRom = document.querySelector('#input-rom');
    var domInputPatch = document.querySelector('#input-patch');
    var domInputSaveAs = document.querySelector('#input-saveas');
    var domInputApply = document.querySelector('#input-apply');
    var domInputSkipChecksums = document.querySelector('#input-skip-checksums')
    var domProgressBar = document.querySelector('#progress-bar');

    var downgrades = MakeJSONGetRequest("https://raw.githubusercontent.com/ComputerElite/APKDowngrader/main/versions.json")
    
    /*
    // testing
    downgrades = {"versions": [{
      "SV": "1.15.0",
      "TV": "1.13.2",
      "SSHA256": "0322e433369e45f793f2a90a6183a77eb7f85954384e7bd018c11001db03293d",
      "DSHA256": "789463bed840a9ecb3ebbff7ed4fe6a2c7e384243b2881865902dd3c8e6ba76c",
      "TSHA256": "cb3157ada1c97e496549ff902b20178f68d803dedd441b5b98c15f6dc3929240",
      "download": "https://mega.nz/file/NzxGiKqb#7c_hi4BJ7n9H6BsboK6TIHdUOaMl1ubVZ4LOGfbp3g0",
      "isDirectDownload": false,
      "appid": "com.beatgames.beatsaber",
      "isXDelta3": false,
      "TargetByteSize": 497495067,
      "SourceByteSize": 579562808
    }]}
    */
    

    downgrades["versions"].forEach(element => {
        //if(element["isXDelta3"]) {
            var ram = (element["isXDelta3"] ? (element["SourceByteSize"]) :  (element["SourceByteSize"] + element["TargetByteSize"])) * (element["isXDelta3"] ? 3.8 : 11) + 10
            console.log(`Estimated RAM usage: ` + ByteSizeToString(ram))
            document.getElementById("patches").innerHTML += GetFormatted(element, ram)
        //}
    });

    function GetFormatted(element, ram) {
        return `<a style="font-size: 16px; color: #EEEEEE; text-align: center; display: flex; width: 100%;" href="${element.download} ` + (element["isDirectDownload"] ? "download" : 'target="_blank"') + `">
                    <div class="item">${element.appid}</div>
                    <div class="item">${element.SV}</div>
                    <div class="` + (ram >= 3221225472 ? `itemR` : `item`) + `">${ByteSizeToString(ram)}</div>
                    <div class="item">${element.TV}</div>
                </a>`
    }

    function attachBinaryInput(selector, onloadend)
    {
        var elem = document.querySelector(selector);
    
        if(!elem)
        {
            return false;
        }
    
        elem.onchange = function(e)
        {
            if(!this.files[0])
            {
                return;
            }
    
            var reader = new FileReader();
            reader.onloadend = function()
            {
                onloadend(reader.result);
            }
            reader.readAsArrayBuffer(this.files[0]);
        }
    }

    attachBinaryInput('#input-rom', function(result)
    {
        sourceData = result;
        autoName();
        setApplyButtonState();
    })
    
    attachBinaryInput('#input-patch', function(result)
    {
        patchData = result;
        autoName();
        setApplyButtonState();
    })
    
    domInputSaveAs.onchange = domInputSaveAs.onkeydown = function()
    {
        setApplyButtonState();
    }
    
    function isReady()
    {
        return (!!domInputRom.files[0] && !!domInputPatch.files[0] && domInputSaveAs.value != '');
    }
    
    function autoName()
    {
        if(domInputSaveAs.value != '' || !domInputRom.files[0] || !domInputPatch.files[0])
        {
            return;
        }
    
        var romFileName = domInputRom.files[0].name;
        var patchFileName = domInputPatch.files[0].name;
    
        var ext = romFileName.split('.').pop();
        var parts = patchFileName.split('.');
        parts.pop();
    
        var name = parts.join('.') + '.' + ext;
    
        domInputSaveAs.value = name;
    }
    
    domInputApply.onclick = function()
    {
        runPatcherSync();
    }
    
    domInputApply.oncontextmenu = function()
    {
        runPatcher();
    }
    
    /*
        RAM usage tests with MS Edge
        - Async downgrading -

        234 MB Base
        1097 MB after selecting
        ~4200 MB while downgrading
        1099 MB After downgrading

        - Sync downgrading -

        268 MB Base
        1099 MB After Selecting
        ~2056 MB while downgrading
        1100 MB After downgrading

        => right click will be async and normal click sync.
    */

    function runPatcherSync()
    {
        if(!isReady())
        {
            return;
        }
        
        disableInputs();
        domProgressBar.style.width = (0.5 * 100) + '%';
        applyPatch(sourceData, patchData, domInputSkipChecksums.checked, domInputPatch.files[0].name, downgrades).then(function(result) {
            console.log("returned")
            if(result) saveAs(domInputSaveAs.value, result);
            enableInputs();
            domProgressBar.style.width = '0px';
        })
        
    }

    function runPatcher()
    {
        if(!isReady())
        {
            return;
        }
    
        disableInputs();
    
        function onpatchend(targetData)
        {
            domProgressBar.style.width = '0px';
            enableInputs();
    
            if(!debug)
            {
                saveAs(domInputSaveAs.value, targetData);
            }
        }
    
        function onprogress(ratio)
        {
            domProgressBar.style.width = (ratio * 100) + '%';
        }
    
        function onerror(message)
        {
            alert("Error: " + message + "\n\n" + "See console output for more information.");
            domProgressBar.style.width = '0px';
            enableInputs();
        }
    
        var config = {
            ignoreChecksums: domInputSkipChecksums.checked,
            onerror: onerror,
            onpatchend: onpatchend,
            onprogress: onprogress
        };
    
        applyPatchAsync(sourceData, patchData, config, domInputPatch.files[0].name, downgrades);
    }
    
    function setApplyButtonState()
    {
        if(!isReady())
        {
            domInputApply.setAttribute('disabled', 'true');
            return;
        }
    
        domInputApply.removeAttribute('disabled');
    }
    
    function disableInputs()
    {
        domInputRom.setAttribute('disabled', 'true');
        domInputPatch.setAttribute('disabled', 'true');
        domInputSaveAs.setAttribute('disabled', 'true');
        domInputApply.setAttribute('disabled', 'true');
    }
    
    function enableInputs()
    {
        domInputRom.removeAttribute('disabled');
        domInputPatch.removeAttribute('disabled');
        domInputSaveAs.removeAttribute('disabled');
        domInputApply.removeAttribute('disabled');
    }
    
    function saveAs(filename, data)
    {
        console.log('saving ' + filename + '...')
    
        var blob = new Blob([data], {type: 'octet/stream'});
        var url = window.URL.createObjectURL(blob);
    
        if(navigator && navigator.msSaveBlob)
        {
            console.log("using msSaveBlob...");
            navigator.msSaveBlob(blob, filename);
        }
        else
        {
            var a = document.createElement('a');
            a.style = "display: none";
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            try
            {
                a.click();
            }
            catch(e)
            {
                console.error(e);
                console.log('failed to save file');
            }
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
    }
    
    </script>
    </body>