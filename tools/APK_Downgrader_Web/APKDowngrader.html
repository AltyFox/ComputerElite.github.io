<head>
    <title>APK Downgrader - Web Version</title>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
    <script src="libpatch.js?2"></script>
    <script src="lzma.js"></script>
    <style>
    td {
        padding: 10px;
    }
    body {
        background: #202225;
        color: #EEE;
    }
    body, table, input {
        font-size: 14px;
        font-family: 'Open Sans';
    }
    a {
        text-decoration: none;
        color: #30A2EC;
    }
    a:visited
    {
        color: #30A2EC;
    }
    
    input[type='file']
    {
        background-color: rgba(0,0,0,0.15);
        padding: 10px;
    }
    
    input[type='text']
    {
        padding: 5px;
        border: none;
        color: #EEEEEE;
        background-color: #202225;
    }

    .red {
        color: #FF2222;
    }

    .green {
        color: #00BB00;
    }

    .os {
        font-size: 16px;
        color: #EEE;
    }

    .item {
        flex: 1;
        width: 30%;
        word-wrap: break-word;
        padding: 3px;
        margin-right: 5%;
    }

    .item2 {
        flex: 1;
        width: 30%;
        word-wrap: break-word;
        padding: 3px;
    }

    .devicesRowItem {
        flex: 1;
        width: 16%;
        text-align: center;
    }

    .devicesRowItemN {
        flex: 1;
        width: 16%;
        color: #FF2222;
        text-align: center;
    }

    .devicesRowItemY {
        flex: 1;
        width: 16%;
        color: #00BB00;
        text-align: center;
    }

    .devicesRow {
        flex: 1;
        display: flex;
        flex-direction: row;
        margin-top: 3px;
        margin-bottom: 3px;
    }

    .guideHeader {
        font-size: 16px;
        margin-top: 10px;
    }

    .guideSteps {
        font-size: 14px;
        margin-top: 5px;
        padding-left: 10px;
    }

    .topicContainer {
        padding-left: 10px;
    }
    
    </style>
    </head>
    <body style="font-size: 14px;">
        <div style="display: flex; flex-direction: column; width: 100%; height: 100%;">
            <div style="flex: 1; flex-grow: 0; text-align: center;">
                <div style="background-color: rgb(47,49,54); display: inline-block; margin-top: 20px; margin-bottom: 10px; width: 80%;">
                    <div style=" padding: 10px;">
                        <div style="font-size: 24px;">APK Downgrader - Web</div>
                        <div style="font-size: 11px; color: #888;">Based on <a href="https://hack64.net/tools/patcher.php" target="_blank">Hack64's Web Patcher</a></div>
                    </div>
                    <table style="padding: 10px; width: 100%;">
                        <tr><td>APK</td><td><input type="file" style="width: 100%;" id="input-rom" accept=".apk"></td></tr>
                        <tr><td>Downgrade file</td><td><input type="file" style="width: 100%;" id="input-patch" accept=".bin, .xdelta, .xdelta3"></td></tr>
                        <tr><td>Save as</td><td><input type="text" style="width: 100%;" id="input-saveas" spellcheck="false"></td></tr>
                    </table>
                    <table style="width: 100%;">
                        <tr>
                            <td>
                                <label style="padding: 5px; font-size: 12px; vertical-align: center;" title="Skip checksum verification (not recommended)">
                                    <input type="checkbox" style="vertical-align: middle;" id="input-skip-checksums">
                                    <span style="margin-left: 5px;">Skip checksums</span>
                                </label>
                            </td>
                            <td style="text-align: right;">
                                <input type="button" value="Downgrade" id="input-apply" disabled="true">
                            </td>
                        </tr>
                    </table>
                    <div style="background: #666; text-align: left;">
                        <div id="progress-bar" style="display: inline-block; height: 2px; width: 0px; background: #00FFFF;"></div>
                    </div>
                </div>
            </div>
            <div style="flex: 1; flex-grow: 0; text-align: center;">
                <div style="background-color: rgb(47,49,54); display: inline-block; margin-top: 10px; width: 80%; margin-bottom: 10px;">
                    <div style="padding: 10px;">
                        <div style="font-size: 24px;">Download patches</div>
                        <div style="font-size: 11px; color: #888;">Pulled from <a href="https://github.com/ComputerElite/APKDowngrader" target="_blank">APK Downgrader</a><i> (click text to download)</i></div>
                        <br/>
                        <div id="patches" style="display: flex; color: #EEEEEE; width: 100%; justify-content: space-evenly; flex-direction: column;">
                            <a style="font-size: 22px; color: #EEEEEE; text-align: center; display: flex; justify-content: center; width: 100%;">
                                <div class="item">App</div>
                                <div class="item">APK Version</div>
                                <div class="item2">Target Version</div>
                            </a>
                            
                        </div>
                        <br/>
                        <div style="font-size: 11px; color: #888;"><a href="https://github.com/ComputerElite/wiki/wiki/APK-Downgrader#how-do-i-generate-downgrade-files" target="_blank">Create patches with APK Downgrader</a></div>
                    </div>
                </div>
            </div>
            <div style="flex: 1; flex-grow: 0; text-align: center;">
                <div style="background-color: rgb(47,49,54); display: inline-block; margin-top: 10px; width: 80%; margin-bottom: 20px;">
                    <div style="padding: 10px;">
                        <div style="font-size: 24px;">Notes</div>
                        <div style="font-size: 20px; text-align: left;">
                            Tested Devices + Browsers
                            <div style="font-size: 11px; color: #888; margin-bottom: 10px; padding-left: 20px;">Tested with Beat Saber 1.15.0 to 1.13.2. Smaller Apps may work on more devices. This data is only by one person each so it might be incorrect. N/A means the browser hasn't been tested/doesn't exist.</i></div>
                            <div class="topicContainer">
                                <div style="font-size: 14;">Since the Web Version uses lots of RAM atm I figured this List would help you a bit.</div> 
                            </br>
                                <div style="font-size: 14px; color: #DDD;">
                                    <div style="display: flex; flex-direction: column;">
                                        <div class="devicesRow" style="font-size: 16px;">
                                            <div class="devicesRowItem">Device</div>
                                            <div class="devicesRowItem">MS Edge</div>
                                            <div class="devicesRowItem">Mozilla Firefox</div>
                                            <div class="devicesRowItem">Google Chrome</div>
                                            <div class="devicesRowItem">Opera</div>
                                            <div class="devicesRowItem">Safari</div>
                                        </div>
                                        <div class="devicesRow">
                                            <div class="devicesRowItem">Oculus Quest 1</div>
                                            <div class="devicesRowItemN">N</div>
                                            <div class="devicesRowItemN">N</div>
                                            <div class="devicesRowItemN">Oculus Broser N</div>
                                            <div class="devicesRowItem">N/A</div>
                                            <div class="devicesRowItem">N/A</div>
                                        </div>
                                        <div class="devicesRow">
                                            <div class="devicesRowItem">Oculus Quest 2</div>
                                            <div class="devicesRowItem">N/A</div>
                                            <div class="devicesRowItem">N/A</div>
                                            <div class="devicesRowItemN">Oculus Broser N</div>
                                            <div class="devicesRowItem">N/A</div>
                                            <div class="devicesRowItem">N/A</div>
                                        </div>
                                        <div class="devicesRow">
                                            <div class="devicesRowItem">Android Phone (4 GB RAM)</div>
                                            <div class="devicesRowItemN">N</div>
                                            <div class="devicesRowItemN">N</div>
                                            <div class="devicesRowItemN">N</div>
                                            <div class="devicesRowItemN">N</div>
                                            <div class="devicesRowItem">N/A</div>
                                        </div>
                                        <div class="devicesRow">
                                            <div class="devicesRowItem">Android Phone (8+ GB RAM)</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItem">N/A</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItemN">N</div>
                                            <div class="devicesRowItem">N/A</div>
                                        </div>
                                        <div class="devicesRow">
                                            <div class="devicesRowItem">Windows (8+ GB RAM)</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItem">N/A</div>
                                        </div>
                                        <div class="devicesRow">
                                            <div class="devicesRowItem">MacOS 10.13.6+ (8+ GB RAM)</div>
                                            <div class="devicesRowItem">N/A</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItemY">Y</div>
                                            <div class="devicesRowItem">N/A</div>
                                            <div class="devicesRowItemY">Y</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 16px;">
                                <div style="font-size: 20px; margin-top: 30px;">Guide
                                    <div style="font-size: 11px; color: #888; margin-bottom: 10px; padding-left: 20px;">Instructions and help with this tool</i></div>
                                    <div class="topicContainer">
                                        
                                        <div class="guideHeader">Downgrading</div>
                                        <div class="guideSteps">
                                            First Backup your APK via Sidequest and download the patch you want to use from the patches section.
                                            Then click Choose file for APK and select the APK you backed up and click Choose File for the downgrade file as well and select the patch you downloaded.
                                            Finally put in the nameyou want the downgraded file to have. e. g. Beat Saber 1.13.2 and hit Downgrade. The file should now download
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="font-size: 16px;">
                                <div style="font-size: 20px; margin-top: 30px;">Common errors
                                    <div style="font-size: 11px; color: #888; margin-bottom: 10px; padding-left: 20px;">Errors which may or may not show</i></div>
                                    <div class="topicContainer">
                                        
                                        <div class="guideHeader">"Array buffer allocation failed" or Browser crashs</div>
                                        <div class="guideSteps">
                                            This means you don't have enough RAM left. Either it'll not work on your device at all or you just have too much RAM in use.
                                        </div>

                                        <div class="guideHeader">Browser doesn't do anything after pressing Downgrade</div>
                                        <div class="guideSteps">
                                            Either your browser doesn't work with This tool or you don't have enough RAM left
                                        </div>
                                    </div>
                                </div>
                            </div>
                                
                        </div>
                        <br/>
                        <div>
                            The Web Version of <a href="https://github.com/ComputerElite/APKDowngrader" target="_blank">APK Downgrader</a> wouldn't have been possible without the work of <a href="https://hack64.net/tools/patcher.php" target="_blank">hack64's Web Patcher</a> which is powering most of the code behind downgrading
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <script>
    
    var sourceData = null;
    var patchData = null;
    var saveAsName = '';
    
    var domInputRom = document.querySelector('#input-rom');
    var domInputPatch = document.querySelector('#input-patch');
    var domInputSaveAs = document.querySelector('#input-saveas');
    var domInputApply = document.querySelector('#input-apply');
    var domInputSkipChecksums = document.querySelector('#input-skip-checksums')
    var domProgressBar = document.querySelector('#progress-bar');

    var downgrades = MakeJSONGetRequest("https://raw.githubusercontent.com/ComputerElite/APKDowngrader/main/versions.json")
    
    downgrades["versions"].forEach(element => {
        if(element["isXDelta3"]) {
            document.getElementById("patches").innerHTML += GetFormatted(element)
        }
    });

    function GetFormatted(element) {
        return `<a style="font-size: 16px; color: #EEEEEE; text-align: center; display: flex; width: 100%;" href="${element.download} ` + (element["isDirectDownload"] ? "download" : 'target="_blank"') + `">
                    <div class="item">${element.appid}</div>
                    <div class="item">${element.SV}</div>
                    <div class="item2">${element.TV}</div>
                </a>`
    }

    function attachBinaryInput(selector, onloadend)
    {
        var elem = document.querySelector(selector);
    
        if(!elem)
        {
            return false;
        }
    
        elem.onchange = function(e)
        {
            if(!this.files[0])
            {
                return;
            }
    
            var reader = new FileReader();
            reader.onloadend = function()
            {
                onloadend(reader.result);
            }
            reader.readAsArrayBuffer(this.files[0]);
        }
    }
    
    attachBinaryInput('#input-rom', function(result)
    {
        sourceData = result;
        autoName();
        setApplyButtonState();
    })
    
    attachBinaryInput('#input-patch', function(result)
    {
        patchData = result;
        autoName();
        setApplyButtonState();
    })
    
    domInputSaveAs.onchange = domInputSaveAs.onkeydown = function()
    {
        setApplyButtonState();
    }
    
    function isReady()
    {
        return (!!domInputRom.files[0] && !!domInputPatch.files[0] && domInputSaveAs.value != '');
    }
    
    function autoName()
    {
        if(domInputSaveAs.value != '' || !domInputRom.files[0] || !domInputPatch.files[0])
        {
            return;
        }
    
        var romFileName = domInputRom.files[0].name;
        var patchFileName = domInputPatch.files[0].name;
    
        var ext = romFileName.split('.').pop();
        var parts = patchFileName.split('.');
        parts.pop();
    
        var name = parts.join('.') + '.' + ext;
    
        domInputSaveAs.value = name;
    }
    
    domInputApply.onclick = function()
    {
        runPatcher();
    }
    
    domInputApply.oncontextmenu = function()
    {
        runPatcher({debug: true});
    }
    
    //Was for testing
    function runPatcherSync()
    {
        var debug = cfg.debug || false;
    
        if(!isReady())
        {
            return;
        }
    
        disableInputs();
        
        saveAs(domInputSaveAs.value, applyPatch(sourceData, patchData, domInputSkipChecksums.checked));
        enableInputs();
        domProgressBar.style.width = '0px';
    }

    function runPatcher(cfg)
    {
        cfg = cfg || {};
        var debug = cfg.debug || false;
    
        if(!isReady())
        {
            return;
        }
    
        disableInputs();
    
        function onpatchend(targetData)
        {
            domProgressBar.style.width = '0px';
            enableInputs();
    
            if(!debug)
            {
                saveAs(domInputSaveAs.value, targetData);
            }
        }
    
        function onprogress(ratio)
        {
            domProgressBar.style.width = (ratio * 100) + '%';
        }
    
        function onerror(message)
        {
            alert("Error: " + message + "\n\n" + "See console output for more information.");
            domProgressBar.style.width = '0px';
            enableInputs();
        }
    
        var config = {
            ignoreChecksums: domInputSkipChecksums.checked,
            onerror: onerror,
            onpatchend: onpatchend,
            onprogress: onprogress
        };
    
        applyPatchAsync(sourceData, patchData, config);
    }
    
    function setApplyButtonState()
    {
        if(!isReady())
        {
            domInputApply.setAttribute('disabled', 'true');
            return;
        }
    
        domInputApply.removeAttribute('disabled');
    }
    
    function disableInputs()
    {
        domInputRom.setAttribute('disabled', 'true');
        domInputPatch.setAttribute('disabled', 'true');
        domInputSaveAs.setAttribute('disabled', 'true');
        domInputApply.setAttribute('disabled', 'true');
    }
    
    function enableInputs()
    {
        domInputRom.removeAttribute('disabled');
        domInputPatch.removeAttribute('disabled');
        domInputSaveAs.removeAttribute('disabled');
        domInputApply.removeAttribute('disabled');
    }

    function MakeTextGetRequest(url) {
        var request = new XMLHttpRequest();
        request.open('GET', url, false);
        request.send(null);
        if (request.status == 200) {
            return request.responseText;
        } else {
            return "Something went wrong: " + request.status;
        }
    }

    function MakeJSONGetRequest(url) {
        return JSON.parse(MakeTextGetRequest(url));
    }
    
    function saveAs(filename, data)
    {
        console.log('saving ' + filename + '...')
    
        var blob = new Blob([data], {type: 'octet/stream'});
        var url = window.URL.createObjectURL(blob);
    
        if(navigator && navigator.msSaveBlob)
        {
            console.log("using msSaveBlob...");
            navigator.msSaveBlob(blob, filename);
        }
        else
        {
            var a = document.createElement('a');
            a.style = "display: none";
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            try
            {
                a.click();
            }
            catch(e)
            {
                console.error(e);
                console.log('failed to save file');
            }
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
    }
    
    </script>
    </body>