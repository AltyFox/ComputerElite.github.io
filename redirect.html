<!DOCTYPE html>
<html>
    <head>
        <title>Redirecting...</title>
        <link href="css/standard.css" type="text/css" rel="stylesheet">
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
        <style>
            body {
                height: 100%;
                padding: 0px;
            }
        </style>
    </head>
    <body>
        <div style="font-size: 38px; text-align: center; width: 100%; height: 100%;" id="funContainer">Redirecting...</div>
        <div id="player"></div>
        <script>
            // URL e. g.
            // https://computerElite.github.io/redirect.html?target=https://www.youtube.com/watch?v=LDU_Txk06tM&start=100&timeout=10000&aftertimeout=https://www.youtube.com/watch?v=dQw4w9WgXcQ
            var url = new URL(window.location.href)
            var target = url.searchParams.get("target")
            if(target == null || target == "") target = "https://www.youtube.com/watch?v=dQw4w9WgXcQ";
            var start = url.searchParams.get("start")
            var timeout = url.searchParams.get("timeout")
            var aftertimeout = url.searchParams.get("aftertimeout")
            var length = url.searchParams.get("length")
            if(length == null) length = 1000
            if(start == null) start = 0
            if(aftertimeout == null) aftertimeout = target
            if(target.startsWith("https://www.youtube.com/watch?v=")) {
                console.log("playing " + target + " starting at " + start)
            } else if(target == "self") {
                document.location.href = window.location.href
            }
            else {
                //console.log(target)
                document.location.href = target
            }
            
            var tag = document.createElement('script');

            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

            // 3. This function creates an <iframe> (and YouTube player)
            //    after the API code downloads.
            var player;
            function onYouTubeIframeAPIReady() {

                if(target.startsWith("https://www.youtube.com/watch?v=")) {
                    document.getElementById("funContainer").style.display = "none";
                    player = new YT.Player('player', {
                    height: document.documentElement.scrollHeight + 'px',
                    width: '100%',
                    playerVars: { 
                        'autoplay': 1,
                        'controls': 0
                    },
                    videoId: target.substring(32, target.length),
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                    });
                }
                
            }

            // 4. The API will call this function when the video player is ready.
            function onPlayerReady(event) {
                event.target.playVideo();
                event.target.seekTo(start, true)
                if(timeout != null) {
                    console.log("opening " + aftertimeout + " in " + timeout + " ms")
                    setTimeout(() => {
                        window.location.href = aftertimeout
                    }, timeout)
                }
            }

            

            // 5. The API calls this function when the player's state changes.
            //    The function indicates that when playing a video (state=1),
            //    the player should play for six seconds and then stop.
            var done = false;
            function onPlayerStateChange(event) {
                if (event.data == YT.PlayerState.PAUSED) {
                    player.playVideo()
                }
            }
            function stopVideo() {
                player.stopVideo();
            }
        </script>
    </body>
</html>